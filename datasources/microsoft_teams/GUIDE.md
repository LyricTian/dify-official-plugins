# Microsoft Teams 数据源插件使用指南

## 概述

Microsoft Teams 数据源插件允许您将 Microsoft Teams 中的团队、频道、消息和聊天作为 Dify 的数据源。

## Azure AD 应用注册

### 步骤 1：创建 Azure AD 应用

1. 访问 [Azure 门户](https://portal.azure.com)
2. 转到 **Azure Active Directory** > **应用注册**
3. 点击 **新注册**
4. 填写应用信息：
   ```
   名称: Dify Microsoft Teams Datasource
   支持的帐户类型: 此组织目录中的帐户
   重定向 URI: Web - https://your-dify-domain.com/console/api/oauth/callback
   ```

### 步骤 2：配置 API 权限

在应用注册页面，转到 **API 权限** 并添加以下权限：

#### Microsoft Graph 权限（委托权限）：
- `Team.ReadBasic.All` - 读取团队基本信息
- `Channel.ReadBasic.All` - 读取频道基本信息
- `ChannelMessage.Read.All` - 读取频道消息
- `Chat.Read` - 读取聊天消息
- `Files.Read.All` - 读取文件
- `User.Read` - 读取用户信息

⚠️ **重要**: 添加权限后，点击 **代表组织授予管理员同意**

### 步骤 3：创建客户端密钥

1. 转到 **证书和密钥**
2. 点击 **新客户端密钥**
3. 设置描述和过期时间
4. **立即复制密钥值**（离开页面后无法再查看）

### 步骤 4：获取必需信息

从应用注册概述页面获取：
- **应用程序(客户端) ID**
- **目录(租户) ID**
- **客户端密钥**（步骤3创建的）

## 在 Dify 中配置

### OAuth 认证配置

1. 在 Dify 中添加 Microsoft Teams 数据源
2. 选择 OAuth 认证方式
3. 填写以下信息：

```yaml
应用程序 ID: 12345678-1234-1234-1234-123456789012
客户端密钥: your-client-secret-value
租户 ID: 87654321-4321-4321-4321-210987654321
```

### 用户授权流程

1. 点击 "连接 Microsoft Teams"
2. 跳转到 Microsoft 登录页面
3. 使用组织账户登录
4. 授权应用访问 Teams 数据
5. 自动返回 Dify 完成配置

## 支持的内容类型

### 1. 团队 (Teams)
- 团队基本信息
- 成员列表和角色
- 团队描述和设置

### 2. 频道 (Channels)
- 标准频道和私有频道
- 频道描述和设置
- 频道成员权限

### 3. 消息 (Messages)
- 频道消息和回复
- 消息格式化内容
- @提及和链接

### 4. 聊天 (Chats) - v1.1.0
- 一对一聊天
- 群组聊天
- 聊天历史记录

### 5. 文件 (Files) - v1.1.0
- 频道共享文件
- 聊天附件
- 文件元数据

## 使用步骤

1. **完成 Azure AD 配置**：按照上述步骤创建应用和权限
2. **在 Dify 中添加数据源**：选择 Microsoft Teams 并配置 OAuth
3. **用户授权**：完成 Microsoft 账户授权流程
4. **浏览内容**：系统自动列出可访问的团队和频道
5. **选择数据**：选择要导入的团队、频道或聊天内容

## 回调 URL 配置

### 生产环境
```
https://your-dify-domain.com/console/api/oauth/callback
```

### 本地开发
```
http://localhost:3000/console/api/oauth/callback
```

### Docker 部署
```
http://your-server-ip:3000/console/api/oauth/callback
```

## 功能特性

### 自动内容处理
- HTML 消息自动转换为纯文本
- 附件信息自动提取
- 回复和@提及关系保持

### 权限处理
- 自动检测用户权限
- 跳过无权限访问的内容
- 详细的错误提示

### 性能优化
- 智能分页加载
- 缓存常用数据
- 限流自动处理

## 权限说明

### 委托权限 vs 应用权限
- **委托权限**: 代表用户访问，遵循用户权限
- **应用权限**: 应用自身权限，需要管理员同意

### 数据访问范围
- 只能访问用户有权限的团队
- 私有频道需要明确邀请
- 聊天数据基于用户参与情况

## 常见问题

### Q: 无法看到某些团队或频道？
A: 检查用户是否有相应的访问权限，某些私有频道需要明确邀请。

### Q: 消息内容显示不完整？
A: Microsoft Graph API 对消息内容有大小限制，超长消息可能被截断。

### Q: 遇到权限错误怎么办？
A: 确保已在 Azure AD 中授予所有必需权限，并点击"代表组织授予管理员同意"。

### Q: 如何处理多租户环境？
A: 每个租户需要单独配置应用注册和权限。

### Q: 支持 Microsoft Teams for Education 吗？
A: 是的，但某些教育特定功能可能需要额外权限。

## 安全注意事项

- 客户端密钥应安全存储，定期轮换
- 监控应用权限使用情况
- 遵循组织的数据治理政策
- 定期审查用户访问权限

## 技术支持

如遇问题，请检查：
1. Azure AD 应用配置是否正确
2. 网络连接和防火墙设置
3. Microsoft Graph API 服务状态
4. 用户权限和租户设置

## 版本更新

### v1.1.0 (当前版本)
- 新增聊天功能支持
- 文件附件访问
- 改进错误处理

### v1.0.0
- 基础团队和频道功能
- OAuth 2.0 认证



